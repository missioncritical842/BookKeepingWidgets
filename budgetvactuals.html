<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Budget vs Actuals</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    #bva-widget {
      font-family: Georgia, serif;
      margin: 20px;
      font-size: 14px;
      color: #333;
    }
    #bva-widget h2 {
      text-align: center;
      margin-bottom: 20px;
      line-height: 1.2;
    }
    #bva-widget h2 .line1 {
      display: block;
      font-size: 20px;
      font-weight: bold;
    }
    #bva-widget h2 .line2 {
      display: block;
      font-size: 16px;
      font-weight: normal;
      color: #555;
    }
    #bva-widget h2 .line3 {
      display: block;
      font-size: 14px;
      font-weight: normal;
      color: #777;
    }
    .section {
      margin-bottom: 30px;
    }
    .section h3 {
      margin-bottom: 8px;
      font-size: 16px;
      font-weight: bold;
      color: #444;
    }
    .bva-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .bva-table th, .bva-table td {
      border: 1px solid #ccc;
      padding: 5px 8px;
      vertical-align: middle;
    }
    .bva-table th {
      background-color: #e6e6e6;
      text-align: center;
      font-size: 13px;
    }
    .bva-table th:first-child {
      text-align: left;
    }
    .bva-table td {
      text-align: right;
      font-size: 13px;
    }
    .bva-table td:first-child {
      text-align: left;
    }
    .parent-row {
      font-weight: bold;
      background-color: #f0f0f0;
    }
    .parent-row-deep {
      font-weight: bold;
      background-color: #f7f7f7;
    }
    .leaf-row {
      font-weight: normal;
    }
    .total-row {
      font-weight: bold;
      background-color: #e0e8f0;
      font-size: 14px;
    }
    .favorable { color: #2a7d2a; }
    .unfavorable { color: #c0392b; }
    .pct-cell { font-size: 12px; color: #666; }
    #summary-section {
      margin-top: 20px;
      border: 2px solid #999;
      border-radius: 6px;
      padding: 15px;
      background-color: #fafafa;
    }
    #summary-section h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      text-align: center;
      color: #333;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .summary-box {
      text-align: center;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }
    .summary-box .label {
      font-size: 12px;
      color: #777;
      margin-bottom: 4px;
    }
    .summary-box .value {
      font-size: 18px;
      font-weight: bold;
    }
    .summary-box .sub {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }
    #error-message {
      color: red;
      font-weight: bold;
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
    }
    @media print {
      #bva-widget { margin: 10px; }
      .summary-box .value { font-size: 16px; }
    }
    @media (max-width: 600px) {
      .bva-table { font-size: 11px; }
      .summary-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="bva-widget">
    <h2>
      <span class="line1" id="orgName">Organization</span>
      <span class="line2">Budget vs Actuals</span>
      <span class="line3" id="subtitle"></span>
    </h2>

    <div class="section">
      <h3>Income</h3>
      <table class="bva-table" id="income-table">
        <tr>
          <th>Account</th>
          <th>Annual Budget</th>
          <th>YTD Budget</th>
          <th>YTD Actual</th>
          <th>Variance</th>
          <th>% Used</th>
        </tr>
      </table>
    </div>

    <div class="section">
      <h3>General Fund Expenses</h3>
      <table class="bva-table" id="general-expense-table">
        <tr>
          <th>Account</th>
          <th>Annual Budget</th>
          <th>YTD Budget</th>
          <th>YTD Actual</th>
          <th>Variance</th>
          <th>% Used</th>
        </tr>
      </table>
    </div>

    <div class="section">
      <h3>Strategic Fund Expenses</h3>
      <table class="bva-table" id="strategic-expense-table">
        <tr>
          <th>Account</th>
          <th>Annual Budget</th>
          <th>YTD Budget</th>
          <th>YTD Actual</th>
          <th>Variance</th>
          <th>% Used</th>
        </tr>
      </table>
    </div>

    <div id="summary-section">
      <h3>Summary</h3>
      <div class="summary-grid">
        <div class="summary-box">
          <div class="label">Net Income (Budget)</div>
          <div class="value" id="net-budget">&mdash;</div>
          <div class="sub">Annual</div>
        </div>
        <div class="summary-box">
          <div class="label">Net Income (Actual YTD)</div>
          <div class="value" id="net-actual">&mdash;</div>
          <div class="sub" id="net-actual-sub"></div>
        </div>
        <div class="summary-box">
          <div class="label">General Fund Balance</div>
          <div class="value" id="general-fund">&mdash;</div>
          <div class="sub" id="general-fund-sub"></div>
        </div>
        <div class="summary-box">
          <div class="label">Strategic Fund Balance</div>
          <div class="value" id="strategic-fund">&mdash;</div>
          <div class="sub" id="strategic-fund-sub"></div>
        </div>
      </div>
    </div>

    <div id="error-message"></div>
  </div>

  <script>
    grist.ready({
      columns: [],
      requiredAccess: 'read table'
    });

    const MONTH_COLS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    function fmt(amount) {
      const abs = Math.abs(amount);
      const str = abs.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      return amount < 0 ? '($' + str + ')' : '$' + str;
    }

    function pct(actual, budget) {
      if (!budget || budget === 0) return '\u2014';
      return Math.round((actual / budget) * 100) + '%';
    }

    function convertToRecords(data) {
      if (Array.isArray(data)) return data;
      const numRows = data.id ? data.id.length : 0;
      const columns = Object.keys(data);
      const records = [];
      for (let i = 0; i < numRows; i++) {
        const record = { id: data.id[i] };
        columns.forEach(function(col) {
          if (col !== 'id') record[col] = data[col][i];
        });
        records.push(record);
      }
      return records;
    }

    async function loadData() {
      var errorEl = document.getElementById('error-message');
      try {
        var results = await Promise.all([
          grist.docApi.fetchTable('Budget'),
          grist.docApi.fetchTable('Transaction_Categorization'),
          grist.docApi.fetchTable('Accounts'),
          grist.docApi.fetchTable('Account_Types'),
          grist.docApi.fetchTable('Organization_Settings'),
          grist.docApi.fetchTable('Fund_Allocations'),
          grist.docApi.fetchTable('Classes')
        ]);
        var budgetData = results[0], transData = results[1], accData = results[2];
        var typeData = results[3], orgData = results[4], allocData = results[5];
        var classData = results[6];

        // Org name
        var orgRecords = convertToRecords(orgData);
        var orgName = (orgRecords.length > 0 && orgRecords[0].Org_Name) ? orgRecords[0].Org_Name : 'Organization';
        document.getElementById('orgName').textContent = orgName;

        // Resolve class IDs by name
        var classRecords = convertToRecords(classData);
        var generalClassId = 0, strategicClassId = 0;
        classRecords.forEach(function(c) {
          if (c.Class_Name === 'General') generalClassId = c.id;
          if (c.Class_Name === 'Strategic') strategicClassId = c.id;
        });

        // Account type map: rowId -> TYPE_NAME
        var typeRecords = convertToRecords(typeData);
        var typeMap = {};
        typeRecords.forEach(function(r) { typeMap[r.id] = r.TYPE_NAME; });

        // Accounts maps
        var accRecords = convertToRecords(accData);
        var accountsById = {};    // Grist row ID -> record
        var accountsByAccId = {}; // ACCOUNT_ID -> record
        var childrenOf = {};      // rowId -> [child rowIds]
        accRecords.forEach(function(r) {
          accountsById[r.id] = r;
          if (r.ACCOUNT_ID) accountsByAccId[r.ACCOUNT_ID] = r;
        });
        // Build children map
        accRecords.forEach(function(r) {
          if (r.PARENT_ACCOUNT) {
            var parent = accountsByAccId[r.PARENT_ACCOUNT];
            if (parent) {
              if (!childrenOf[parent.id]) childrenOf[parent.id] = [];
              childrenOf[parent.id].push(r.id);
            }
          }
        });

        // Year and month
        var now = new Date();
        var year = now.getFullYear();
        var currentMonth = now.getMonth() + 1;
        document.getElementById('subtitle').textContent =
          year + ' \u2014 Through ' + MONTH_NAMES[currentMonth - 1];

        // --- BUDGET DATA (split by fund) ---
        var budgetRecords = convertToRecords(budgetData).filter(function(b) { return b.Year === year; });
        var generalBudgetMap = {};   // accountRowId -> {annual, ytdBudget}
        var strategicBudgetMap = {};
        budgetRecords.forEach(function(b) {
          var annual = 0, ytdBudget = 0;
          MONTH_COLS.forEach(function(col, idx) {
            var val = b[col] || 0;
            annual += val;
            if (idx < currentMonth) ytdBudget += val;
          });
          var fund = b.Fund || 0;
          var map = (fund === strategicClassId) ? strategicBudgetMap : generalBudgetMap;
          map[b.Account] = { annual: annual, ytdBudget: ytdBudget };
        });

        // --- ACTUALS DATA (split by class) ---
        var transRecords = convertToRecords(transData);
        var generalActualsMap = {};   // accountRowId -> raw YTD amount
        var strategicActualsMap = {};
        transRecords.forEach(function(t) {
          if (!t.Year_Posted || !t.Month_Posted) return;
          if (t.Year_Posted !== year) return;
          if (t.Month_Posted > currentMonth) return;
          var amount = t.Amount || 0;
          var accountRef = t.Account_Long_Name;
          if (!accountRef) return;
          var cls = t.Class2 || 0;
          if (cls === strategicClassId) {
            strategicActualsMap[accountRef] = (strategicActualsMap[accountRef] || 0) + amount;
          } else {
            generalActualsMap[accountRef] = (generalActualsMap[accountRef] || 0) + amount;
          }
        });

        // --- REUSABLE TREE BUILDER ---
        function buildTree(budgetMap, actualsMap) {
          var treeNodes = {};

          function ensureNode(accountRowId) {
            if (treeNodes[accountRowId]) return treeNodes[accountRowId];
            var acct = accountsById[accountRowId];
            if (!acct) return null;
            var typeName = typeMap[acct.ACCOUNT_TYPE];
            if (!typeName || (typeName !== 'INCOME' && typeName !== 'EXPENSE')) return null;

            var node = {
              id: accountRowId, name: acct.ACCOUNT_NAME, typeName: typeName,
              children: [], _childSet: {}, parentNodeId: null,
              annual: 0, ytdBudget: 0, ytdActual: 0, isLeaf: true
            };
            treeNodes[accountRowId] = node;

            if (acct.PARENT_ACCOUNT) {
              var parent = accountsByAccId[acct.PARENT_ACCOUNT];
              if (parent) {
                var parentNode = ensureNode(parent.id);
                if (parentNode && !parentNode._childSet[accountRowId]) {
                  parentNode.children.push(node);
                  parentNode._childSet[accountRowId] = true;
                  parentNode.isLeaf = false;
                  node.parentNodeId = parent.id;
                }
              }
            }
            return node;
          }

          // Create nodes for all active accounts
          Object.keys(budgetMap).forEach(function(id) { ensureNode(Number(id)); });
          Object.keys(actualsMap).forEach(function(id) { ensureNode(Number(id)); });

          // Assign values
          Object.keys(budgetMap).forEach(function(id) {
            var node = treeNodes[Number(id)];
            if (node) { node.annual = budgetMap[Number(id)].annual; node.ytdBudget = budgetMap[Number(id)].ytdBudget; }
          });
          Object.keys(actualsMap).forEach(function(id) {
            var node = treeNodes[Number(id)];
            if (node) { node.ytdActual = actualsMap[Number(id)]; }
          });

          // Roll up
          function rollUp(node) {
            if (node.children.length === 0) return;
            node.children.forEach(function(child) { rollUp(child); });
            node.annual += node.children.reduce(function(s, c) { return s + c.annual; }, 0);
            node.ytdBudget += node.children.reduce(function(s, c) { return s + c.ytdBudget; }, 0);
            node.ytdActual += node.children.reduce(function(s, c) { return s + c.ytdActual; }, 0);
          }

          var roots = [];
          Object.keys(treeNodes).forEach(function(id) {
            if (!treeNodes[id].parentNodeId) roots.push(treeNodes[id]);
          });
          roots.forEach(function(r) { rollUp(r); });

          // Flatten
          function flattenTree(node, depth) {
            var rows = [];
            if (Math.abs(node.annual) < 0.005 && Math.abs(node.ytdBudget) < 0.005 && Math.abs(node.ytdActual) < 0.005) return rows;
            rows.push({ name: node.name, annual: node.annual, ytdBudget: node.ytdBudget, ytdActual: node.ytdActual, isLeaf: node.isLeaf, depth: depth });
            var sorted = node.children.slice().sort(function(a, b) { return a.name.localeCompare(b.name); });
            sorted.forEach(function(child) { rows.push.apply(rows, flattenTree(child, depth + 1)); });
            return rows;
          }

          var incomeRoots = roots.filter(function(r) { return r.typeName === 'INCOME'; });
          var expenseRoots = roots.filter(function(r) { return r.typeName === 'EXPENSE'; });
          incomeRoots.sort(function(a, b) { return a.name.localeCompare(b.name); });
          expenseRoots.sort(function(a, b) { return a.name.localeCompare(b.name); });

          var incomeRows = [], expenseRows = [];
          incomeRoots.forEach(function(r) { incomeRows.push.apply(incomeRows, flattenTree(r, 0)); });
          expenseRoots.forEach(function(r) { expenseRows.push.apply(expenseRows, flattenTree(r, 0)); });

          var totIncAnnual = 0, totIncYtdBgt = 0, totIncYtdAct = 0;
          incomeRoots.forEach(function(r) { totIncAnnual += r.annual; totIncYtdBgt += r.ytdBudget; totIncYtdAct += r.ytdActual; });
          var totExpAnnual = 0, totExpYtdBgt = 0, totExpYtdAct = 0;
          expenseRoots.forEach(function(r) { totExpAnnual += r.annual; totExpYtdBgt += r.ytdBudget; totExpYtdAct += Math.abs(r.ytdActual); });

          return {
            incomeRows: incomeRows, expenseRows: expenseRows,
            totIncAnnual: totIncAnnual, totIncYtdBgt: totIncYtdBgt, totIncYtdAct: totIncYtdAct,
            totExpAnnual: totExpAnnual, totExpYtdBgt: totExpYtdBgt, totExpYtdAct: totExpYtdAct
          };
        }

        // Build trees for each fund
        var genTree = buildTree(generalBudgetMap, generalActualsMap);
        var stratTree = buildTree(strategicBudgetMap, strategicActualsMap);

        // --- RENDER INCOME (General fund only) ---
        var incomeTable = document.getElementById('income-table');
        genTree.incomeRows.forEach(function(row) {
          var variance = row.ytdActual - row.ytdBudget;
          addRow(incomeTable, row.name, row.annual, row.ytdBudget, row.ytdActual, variance, true, row.depth, row.isLeaf);
        });
        var incomeVariance = genTree.totIncYtdAct - genTree.totIncYtdBgt;
        addTotalRow(incomeTable, 'Total Income',
          genTree.totIncAnnual, genTree.totIncYtdBgt, genTree.totIncYtdAct, incomeVariance, true);

        // --- RENDER GENERAL FUND EXPENSES ---
        var genExpTable = document.getElementById('general-expense-table');
        genTree.expenseRows.forEach(function(row) {
          var actual = Math.abs(row.ytdActual);
          var variance = row.ytdBudget - actual;
          addRow(genExpTable, row.name, row.annual, row.ytdBudget, actual, variance, false, row.depth, row.isLeaf);
        });
        var genExpVariance = genTree.totExpYtdBgt - genTree.totExpYtdAct;
        addTotalRow(genExpTable, 'Total General Fund Expenses',
          genTree.totExpAnnual, genTree.totExpYtdBgt, genTree.totExpYtdAct, genExpVariance, false);

        // --- RENDER STRATEGIC FUND EXPENSES ---
        var stratExpTable = document.getElementById('strategic-expense-table');
        stratTree.expenseRows.forEach(function(row) {
          var actual = Math.abs(row.ytdActual);
          var variance = row.ytdBudget - actual;
          addRow(stratExpTable, row.name, row.annual, row.ytdBudget, actual, variance, false, row.depth, row.isLeaf);
        });
        if (stratTree.expenseRows.length === 0) {
          var emptyRow = stratExpTable.insertRow();
          var emptyCell = emptyRow.insertCell(0);
          emptyCell.colSpan = 6;
          emptyCell.textContent = 'No strategic fund expenses yet';
          emptyCell.style.textAlign = 'center';
          emptyCell.style.color = '#999';
          emptyCell.style.fontStyle = 'italic';
        }
        var stratExpVariance = stratTree.totExpYtdBgt - stratTree.totExpYtdAct;
        addTotalRow(stratExpTable, 'Total Strategic Fund Expenses',
          stratTree.totExpAnnual, stratTree.totExpYtdBgt, stratTree.totExpYtdAct, stratExpVariance, false);

        // --- SUMMARY ---
        var netBudget = genTree.totIncAnnual - genTree.totExpAnnual;
        var netActual = genTree.totIncYtdAct - genTree.totExpYtdAct;

        document.getElementById('net-budget').textContent = fmt(netBudget);
        document.getElementById('net-budget').className = 'value ' + (netBudget >= 0 ? 'favorable' : 'unfavorable');

        document.getElementById('net-actual').textContent = fmt(netActual);
        document.getElementById('net-actual').className = 'value ' + (netActual >= 0 ? 'favorable' : 'unfavorable');
        document.getElementById('net-actual-sub').textContent =
          'Through ' + MONTH_NAMES[currentMonth - 1];

        // --- FUND BALANCES ---
        // General Fund = sum of General-class transactions (all time) - strategic allocations
        var generalTransNet = 0;
        var strategicTransNet = 0;
        transRecords.forEach(function(t) {
          if (!t.Year_Posted || !t.Month_Posted) return;
          if (t.Year_Posted > year) return;
          if (t.Year_Posted === year && t.Month_Posted > currentMonth) return;
          var cls = t.Class2 || 0;
          var amount = t.Amount || 0;
          if (cls === strategicClassId) {
            strategicTransNet += amount;
          } else {
            // General class or unclassified
            generalTransNet += amount;
          }
        });

        // Strategic Fund = allocations + strategic-class transactions (expenses reduce it)
        var allocRecords = convertToRecords(allocData);
        var totalAllocations = 0;
        allocRecords.forEach(function(a) {
          totalAllocations += (a.Strategic_Amount || 0);
        });
        var strategicBalance = totalAllocations + strategicTransNet;

        // General Fund = general-class net income - allocations moved to strategic
        var generalBalance = generalTransNet - totalAllocations;

        document.getElementById('general-fund').textContent = fmt(generalBalance);
        document.getElementById('general-fund').className = 'value ' + (generalBalance >= 0 ? 'favorable' : 'unfavorable');
        document.getElementById('general-fund-sub').textContent =
          'Through ' + MONTH_NAMES[currentMonth - 1] + ' ' + year;

        document.getElementById('strategic-fund').textContent = fmt(strategicBalance);
        document.getElementById('strategic-fund').className = 'value ' + (strategicBalance >= 0 ? 'favorable' : 'unfavorable');
        document.getElementById('strategic-fund-sub').textContent =
          '$' + totalAllocations.toLocaleString(undefined, {minimumFractionDigits: 0}) + ' allocated, '
          + (strategicTransNet !== 0 ? fmt(strategicTransNet) + ' spent' : 'no expenses yet');

      } catch (err) {
        console.error('Error loading data:', err);
        errorEl.textContent = 'Error loading data: ' + err.message;
      }
    }

    function addRow(table, name, annual, ytdBudget, ytdActual, variance, isIncome, depth, isLeaf) {
      var row = table.insertRow();
      var indent = 8 + (depth * 20);

      if (!isLeaf) {
        row.className = depth === 0 ? 'parent-row' : 'parent-row-deep';
      } else {
        row.className = 'leaf-row';
      }

      var nameCell = row.insertCell(0);
      var annualCell = row.insertCell(1);
      var ytdBudgetCell = row.insertCell(2);
      var ytdActualCell = row.insertCell(3);
      var varianceCell = row.insertCell(4);
      var pctCell = row.insertCell(5);

      nameCell.textContent = name;
      nameCell.style.paddingLeft = indent + 'px';

      annualCell.textContent = fmt(annual);
      ytdBudgetCell.textContent = fmt(ytdBudget);
      ytdActualCell.textContent = fmt(ytdActual);
      varianceCell.textContent = fmt(variance);
      varianceCell.className = variance >= 0 ? 'favorable' : 'unfavorable';
      pctCell.textContent = pct(ytdActual, annual);
      pctCell.className = 'pct-cell';
    }

    function addTotalRow(table, label, annual, ytdBudget, ytdActual, variance, isIncome) {
      var row = table.insertRow();
      row.className = 'total-row';
      var nameCell = row.insertCell(0);
      var annualCell = row.insertCell(1);
      var ytdBudgetCell = row.insertCell(2);
      var ytdActualCell = row.insertCell(3);
      var varianceCell = row.insertCell(4);
      var pctCell = row.insertCell(5);

      nameCell.textContent = label;
      annualCell.textContent = fmt(annual);
      ytdBudgetCell.textContent = fmt(ytdBudget);
      ytdActualCell.textContent = fmt(ytdActual);
      varianceCell.textContent = fmt(variance);
      varianceCell.className = variance >= 0 ? 'favorable' : 'unfavorable';
      pctCell.textContent = pct(ytdActual, annual);
      pctCell.className = 'pct-cell';
    }

    loadData();
  </script>
</body>
</html>
