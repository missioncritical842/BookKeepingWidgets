<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Budget vs Actuals</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    #bva-widget {
      font-family: Georgia, serif;
      margin: 20px;
      font-size: 14px;
      color: #333;
    }
    #bva-widget h2 {
      text-align: center;
      margin-bottom: 20px;
      line-height: 1.2;
    }
    #bva-widget h2 .line1 { display: block; font-size: 20px; font-weight: bold; }
    #bva-widget h2 .line2 { display: block; font-size: 16px; font-weight: normal; color: #555; }
    #bva-widget h2 .line3 { display: block; font-size: 14px; font-weight: normal; color: #777; }
    .section { margin-bottom: 30px; }
    .section h3 { margin-bottom: 8px; font-size: 16px; font-weight: bold; color: #444; }
    .bva-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .bva-table th, .bva-table td {
      border: 1px solid #ccc;
      padding: 5px 8px;
      vertical-align: middle;
    }
    .bva-table th { background-color: #e6e6e6; text-align: center; font-size: 13px; }
    .bva-table th:first-child { text-align: left; }
    .bva-table td { text-align: right; font-size: 13px; }
    .bva-table td:first-child { text-align: left; }
    .parent-row { font-weight: bold; background-color: #f0f0f0; cursor: pointer; }
    .parent-row:hover { background-color: #e8e8e8; }
    .parent-row-deep { font-weight: bold; background-color: #f7f7f7; cursor: pointer; }
    .parent-row-deep:hover { background-color: #efefef; }
    .leaf-row { font-weight: normal; }
    .total-row { font-weight: bold; background-color: #e0e8f0; font-size: 14px; }
    .favorable { color: #2a7d2a; }
    .unfavorable { color: #c0392b; }
    .pct-cell { font-size: 12px; color: #666; }
    .toggle {
      display: inline-block;
      width: 16px;
      font-size: 10px;
      color: #666;
      user-select: none;
    }
    #summary-section {
      margin-top: 20px;
      border: 2px solid #999;
      border-radius: 6px;
      padding: 15px;
      background-color: #fafafa;
    }
    #summary-section h3 { margin: 0 0 10px 0; font-size: 16px; text-align: center; color: #333; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .summary-box {
      text-align: center; padding: 10px;
      border: 1px solid #ddd; border-radius: 4px; background: #fff;
    }
    .summary-box .label { font-size: 12px; color: #777; margin-bottom: 4px; }
    .summary-box .value { font-size: 18px; font-weight: bold; }
    .summary-box .sub { font-size: 11px; color: #999; margin-top: 2px; }
    #error-message { color: red; font-weight: bold; margin-top: 10px; text-align: center; font-size: 14px; }
    @media print {
      #bva-widget { margin: 10px; }
      .summary-box .value { font-size: 16px; }
      .toggle { display: none; }
    }
    @media (max-width: 600px) {
      .bva-table { font-size: 11px; }
      .summary-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="bva-widget">
    <h2>
      <span class="line1" id="orgName">Organization</span>
      <span class="line2">Budget vs Actuals</span>
      <span class="line3" id="subtitle"></span>
    </h2>

    <div class="section">
      <h3>Income</h3>
      <table class="bva-table" id="income-table">
        <tr><th>Account</th><th>Annual Budget</th><th>YTD Budget</th><th>YTD Actual</th><th>Variance</th><th>% Used</th></tr>
      </table>
    </div>

    <div class="section">
      <h3>General Fund Expenses</h3>
      <table class="bva-table" id="general-expense-table">
        <tr><th>Account</th><th>Annual Budget</th><th>YTD Budget</th><th>YTD Actual</th><th>Variance</th><th>% Used</th></tr>
      </table>
    </div>

    <div class="section">
      <h3>Strategic Fund Expenses</h3>
      <table class="bva-table" id="strategic-expense-table">
        <tr><th>Account</th><th>Annual Budget</th><th>YTD Budget</th><th>YTD Actual</th><th>Variance</th><th>% Used</th></tr>
      </table>
    </div>

    <div id="summary-section">
      <h3>Summary</h3>
      <div class="summary-grid">
        <div class="summary-box">
          <div class="label">Net Income (Budget)</div>
          <div class="value" id="net-budget">&mdash;</div>
          <div class="sub">Annual</div>
        </div>
        <div class="summary-box">
          <div class="label">Net Income (Actual YTD)</div>
          <div class="value" id="net-actual">&mdash;</div>
          <div class="sub" id="net-actual-sub"></div>
        </div>
        <div class="summary-box">
          <div class="label">General Fund Balance</div>
          <div class="value" id="general-fund">&mdash;</div>
          <div class="sub" id="general-fund-sub"></div>
        </div>
        <div class="summary-box">
          <div class="label">Strategic Fund Balance</div>
          <div class="value" id="strategic-fund">&mdash;</div>
          <div class="sub" id="strategic-fund-sub"></div>
        </div>
      </div>
    </div>

    <div id="error-message"></div>
  </div>

  <script>
    grist.ready({ columns: [], requiredAccess: 'read table' });

    var MONTH_COLS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    function fmt(amount) {
      var abs = Math.abs(amount);
      var str = abs.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      return amount < 0 ? '($' + str + ')' : '$' + str;
    }

    function pct(actual, budget) {
      if (!budget || budget === 0) return '\u2014';
      return Math.round((actual / budget) * 100) + '%';
    }

    function convertToRecords(data) {
      if (Array.isArray(data)) return data;
      var numRows = data.id ? data.id.length : 0;
      var columns = Object.keys(data);
      var records = [];
      for (var i = 0; i < numRows; i++) {
        var record = { id: data.id[i] };
        columns.forEach(function(col) { if (col !== 'id') record[col] = data[col][i]; });
        records.push(record);
      }
      return records;
    }

    // --- TOGGLE LOGIC ---
    function toggleChildren(nodeId, tableId) {
      var table = document.getElementById(tableId);
      var children = table.querySelectorAll('tr[data-parent-node="' + nodeId + '"]');
      if (children.length === 0) return;
      var expanding = children[0].style.display === 'none';

      for (var i = 0; i < children.length; i++) {
        var child = children[i];
        if (expanding) {
          child.style.display = '';
        } else {
          child.style.display = 'none';
          // Recursively collapse any expanded grandchildren
          if (child.getAttribute('data-has-children') === 'true') {
            collapseDescendants(child.getAttribute('data-node-id'), tableId);
            var t = child.querySelector('.toggle');
            if (t) t.textContent = '\u25B6 ';
          }
        }
      }

      // Update toggle indicator on the clicked parent
      var parentRow = table.querySelector('tr[data-node-id="' + nodeId + '"]');
      if (parentRow) {
        var toggle = parentRow.querySelector('.toggle');
        if (toggle) toggle.textContent = expanding ? '\u25BC ' : '\u25B6 ';
      }
    }

    function collapseDescendants(nodeId, tableId) {
      var table = document.getElementById(tableId);
      var children = table.querySelectorAll('tr[data-parent-node="' + nodeId + '"]');
      for (var i = 0; i < children.length; i++) {
        children[i].style.display = 'none';
        if (children[i].getAttribute('data-has-children') === 'true') {
          var t = children[i].querySelector('.toggle');
          if (t) t.textContent = '\u25B6 ';
          collapseDescendants(children[i].getAttribute('data-node-id'), tableId);
        }
      }
    }

    async function loadData() {
      var errorEl = document.getElementById('error-message');
      try {
        var results = await Promise.all([
          grist.docApi.fetchTable('Budget'),
          grist.docApi.fetchTable('Transaction_Categorization'),
          grist.docApi.fetchTable('Accounts'),
          grist.docApi.fetchTable('Account_Types'),
          grist.docApi.fetchTable('Organization_Settings'),
          grist.docApi.fetchTable('Classes')
        ]);
        var budgetData = results[0], transData = results[1], accData = results[2];
        var typeData = results[3], orgData = results[4], classData = results[5];

        var orgRecords = convertToRecords(orgData);
        var orgName = (orgRecords.length > 0 && orgRecords[0].Org_Name) ? orgRecords[0].Org_Name : 'Organization';
        document.getElementById('orgName').textContent = orgName;

        var classRecords = convertToRecords(classData);
        var generalClassId = 0, strategicClassId = 0;
        classRecords.forEach(function(c) {
          if (c.Class_Name === 'General') generalClassId = c.id;
          if (c.Class_Name === 'Strategic') strategicClassId = c.id;
        });

        var typeRecords = convertToRecords(typeData);
        var typeMap = {};
        typeRecords.forEach(function(r) { typeMap[r.id] = r.TYPE_NAME; });

        var accRecords = convertToRecords(accData);
        var accountsById = {}, accountsByAccId = {};
        accRecords.forEach(function(r) {
          accountsById[r.id] = r;
          if (r.ACCOUNT_ID) accountsByAccId[r.ACCOUNT_ID] = r;
        });

        var now = new Date();
        var year = now.getFullYear();
        var currentMonth = now.getMonth() + 1;
        document.getElementById('subtitle').textContent =
          year + ' \u2014 Through ' + MONTH_NAMES[currentMonth - 1];

        // --- BUDGET DATA (split by fund) ---
        var budgetRecords = convertToRecords(budgetData).filter(function(b) { return b.Year === year; });
        var generalBudgetMap = {}, strategicBudgetMap = {};
        budgetRecords.forEach(function(b) {
          var annual = 0, ytdBudget = 0;
          MONTH_COLS.forEach(function(col, idx) {
            var val = b[col] || 0;
            annual += val;
            if (idx < currentMonth) ytdBudget += val;
          });
          var fund = b.Fund || 0;
          var map = (fund === strategicClassId) ? strategicBudgetMap : generalBudgetMap;
          map[b.Account] = { annual: annual, ytdBudget: ytdBudget };
        });

        // --- ACTUALS DATA (split by class) ---
        var transRecords = convertToRecords(transData);
        var generalActualsMap = {}, strategicActualsMap = {};
        transRecords.forEach(function(t) {
          if (!t.Year_Posted || !t.Month_Posted) return;
          if (t.Year_Posted !== year) return;
          if (t.Month_Posted > currentMonth) return;
          var amount = t.Amount || 0;
          var accountRef = t.Account_Long_Name;
          if (!accountRef) return;
          var cls = t.Class2 || 0;
          if (cls === strategicClassId) {
            strategicActualsMap[accountRef] = (strategicActualsMap[accountRef] || 0) + amount;
          } else {
            generalActualsMap[accountRef] = (generalActualsMap[accountRef] || 0) + amount;
          }
        });

        // --- REUSABLE TREE BUILDER ---
        function buildTree(budgetMap, actualsMap) {
          var treeNodes = {};

          function ensureNode(accountRowId) {
            if (treeNodes[accountRowId]) return treeNodes[accountRowId];
            var acct = accountsById[accountRowId];
            if (!acct) return null;
            var typeName = typeMap[acct.ACCOUNT_TYPE];
            if (!typeName || (typeName !== 'INCOME' && typeName !== 'EXPENSE')) return null;

            var node = {
              id: accountRowId, name: acct.ACCOUNT_NAME, typeName: typeName,
              children: [], _childSet: {}, parentNodeId: null,
              annual: 0, ytdBudget: 0, ytdActual: 0, isLeaf: true
            };
            treeNodes[accountRowId] = node;

            if (acct.PARENT_ACCOUNT) {
              var parent = accountsByAccId[acct.PARENT_ACCOUNT];
              if (parent) {
                var parentNode = ensureNode(parent.id);
                if (parentNode && !parentNode._childSet[accountRowId]) {
                  parentNode.children.push(node);
                  parentNode._childSet[accountRowId] = true;
                  parentNode.isLeaf = false;
                  node.parentNodeId = parent.id;
                }
              }
            }
            return node;
          }

          Object.keys(budgetMap).forEach(function(id) { ensureNode(Number(id)); });
          Object.keys(actualsMap).forEach(function(id) { ensureNode(Number(id)); });

          Object.keys(budgetMap).forEach(function(id) {
            var node = treeNodes[Number(id)];
            if (node) { node.annual = budgetMap[Number(id)].annual; node.ytdBudget = budgetMap[Number(id)].ytdBudget; }
          });
          Object.keys(actualsMap).forEach(function(id) {
            var node = treeNodes[Number(id)];
            if (node) { node.ytdActual = actualsMap[Number(id)]; }
          });

          function rollUp(node) {
            if (node.children.length === 0) return;
            node.children.forEach(function(child) { rollUp(child); });
            node.annual += node.children.reduce(function(s, c) { return s + c.annual; }, 0);
            node.ytdBudget += node.children.reduce(function(s, c) { return s + c.ytdBudget; }, 0);
            node.ytdActual += node.children.reduce(function(s, c) { return s + c.ytdActual; }, 0);
          }

          var roots = [];
          Object.keys(treeNodes).forEach(function(id) {
            if (!treeNodes[id].parentNodeId) roots.push(treeNodes[id]);
          });
          roots.forEach(function(r) { rollUp(r); });

          // Flatten with parent tracking
          function flattenTree(node, depth, parentId) {
            var rows = [];
            if (Math.abs(node.annual) < 0.005 && Math.abs(node.ytdBudget) < 0.005 && Math.abs(node.ytdActual) < 0.005) return rows;
            var hasChildren = false;
            var activeChildren = node.children.filter(function(c) {
              return Math.abs(c.annual) >= 0.005 || Math.abs(c.ytdBudget) >= 0.005 || Math.abs(c.ytdActual) >= 0.005;
            });
            hasChildren = activeChildren.length > 0;

            rows.push({
              nodeId: node.id, parentId: parentId, name: node.name,
              annual: node.annual, ytdBudget: node.ytdBudget, ytdActual: node.ytdActual,
              isLeaf: node.isLeaf, hasChildren: hasChildren, depth: depth
            });
            var sorted = activeChildren.slice().sort(function(a, b) { return a.name.localeCompare(b.name); });
            sorted.forEach(function(child) {
              rows.push.apply(rows, flattenTree(child, depth + 1, node.id));
            });
            return rows;
          }

          var incomeRoots = roots.filter(function(r) { return r.typeName === 'INCOME'; });
          var expenseRoots = roots.filter(function(r) { return r.typeName === 'EXPENSE'; });
          incomeRoots.sort(function(a, b) { return a.name.localeCompare(b.name); });
          expenseRoots.sort(function(a, b) { return a.name.localeCompare(b.name); });

          var incomeRows = [], expenseRows = [];
          incomeRoots.forEach(function(r) { incomeRows.push.apply(incomeRows, flattenTree(r, 0, null)); });
          expenseRoots.forEach(function(r) { expenseRows.push.apply(expenseRows, flattenTree(r, 0, null)); });

          var totIncAnnual = 0, totIncYtdBgt = 0, totIncYtdAct = 0;
          incomeRoots.forEach(function(r) { totIncAnnual += r.annual; totIncYtdBgt += r.ytdBudget; totIncYtdAct += r.ytdActual; });
          var totExpAnnual = 0, totExpYtdBgt = 0, totExpYtdAct = 0;
          expenseRoots.forEach(function(r) { totExpAnnual += r.annual; totExpYtdBgt += r.ytdBudget; totExpYtdAct += Math.abs(r.ytdActual); });

          return {
            incomeRows: incomeRows, expenseRows: expenseRows,
            totIncAnnual: totIncAnnual, totIncYtdBgt: totIncYtdBgt, totIncYtdAct: totIncYtdAct,
            totExpAnnual: totExpAnnual, totExpYtdBgt: totExpYtdBgt, totExpYtdAct: totExpYtdAct
          };
        }

        var genTree = buildTree(generalBudgetMap, generalActualsMap);
        var stratTree = buildTree(strategicBudgetMap, strategicActualsMap);

        // --- RENDER ---
        var incomeTable = document.getElementById('income-table');
        genTree.incomeRows.forEach(function(row) {
          var variance = row.ytdActual - row.ytdBudget;
          addRow(incomeTable, 'income-table', row, row.annual, row.ytdBudget, row.ytdActual, variance, true);
        });
        addTotalRow(incomeTable, 'Total Income',
          genTree.totIncAnnual, genTree.totIncYtdBgt, genTree.totIncYtdAct,
          genTree.totIncYtdAct - genTree.totIncYtdBgt, true);

        var genExpTable = document.getElementById('general-expense-table');
        genTree.expenseRows.forEach(function(row) {
          var actual = Math.abs(row.ytdActual);
          addRow(genExpTable, 'general-expense-table', row, row.annual, row.ytdBudget, actual, row.ytdBudget - actual, false);
        });
        addTotalRow(genExpTable, 'Total General Fund Expenses',
          genTree.totExpAnnual, genTree.totExpYtdBgt, genTree.totExpYtdAct,
          genTree.totExpYtdBgt - genTree.totExpYtdAct, false);

        var stratExpTable = document.getElementById('strategic-expense-table');
        stratTree.expenseRows.forEach(function(row) {
          var actual = Math.abs(row.ytdActual);
          addRow(stratExpTable, 'strategic-expense-table', row, row.annual, row.ytdBudget, actual, row.ytdBudget - actual, false);
        });
        if (stratTree.expenseRows.length === 0) {
          var emptyRow = stratExpTable.insertRow();
          var emptyCell = emptyRow.insertCell(0);
          emptyCell.colSpan = 6;
          emptyCell.textContent = 'No strategic fund expenses yet';
          emptyCell.style.textAlign = 'center';
          emptyCell.style.color = '#999';
          emptyCell.style.fontStyle = 'italic';
        }
        addTotalRow(stratExpTable, 'Total Strategic Fund Expenses',
          stratTree.totExpAnnual, stratTree.totExpYtdBgt, stratTree.totExpYtdAct,
          stratTree.totExpYtdBgt - stratTree.totExpYtdAct, false);

        // --- SUMMARY ---
        var netBudget = genTree.totIncAnnual - genTree.totExpAnnual;
        var netActual = genTree.totIncYtdAct - genTree.totExpYtdAct;

        document.getElementById('net-budget').textContent = fmt(netBudget);
        document.getElementById('net-budget').className = 'value ' + (netBudget >= 0 ? 'favorable' : 'unfavorable');
        document.getElementById('net-actual').textContent = fmt(netActual);
        document.getElementById('net-actual').className = 'value ' + (netActual >= 0 ? 'favorable' : 'unfavorable');
        document.getElementById('net-actual-sub').textContent = 'Through ' + MONTH_NAMES[currentMonth - 1];

        // --- FUND BALANCES ---
        var generalBalance = 0, strategicBalance = 0;
        transRecords.forEach(function(t) {
          if (!t.Year_Posted || !t.Month_Posted) return;
          if (t.Year_Posted > year) return;
          if (t.Year_Posted === year && t.Month_Posted > currentMonth) return;
          var cls = t.Class2 || 0;
          var amount = t.Amount || 0;
          if (cls === strategicClassId) { strategicBalance += amount; }
          else { generalBalance += amount; }
        });

        document.getElementById('general-fund').textContent = fmt(generalBalance);
        document.getElementById('general-fund').className = 'value ' + (generalBalance >= 0 ? 'favorable' : 'unfavorable');
        document.getElementById('general-fund-sub').textContent = 'Through ' + MONTH_NAMES[currentMonth - 1] + ' ' + year;
        document.getElementById('strategic-fund').textContent = fmt(strategicBalance);
        document.getElementById('strategic-fund').className = 'value ' + (strategicBalance >= 0 ? 'favorable' : 'unfavorable');
        document.getElementById('strategic-fund-sub').textContent = 'Through ' + MONTH_NAMES[currentMonth - 1] + ' ' + year;

      } catch (err) {
        console.error('Error loading data:', err);
        errorEl.textContent = 'Error loading data: ' + err.message;
      }
    }

    function addRow(table, tableId, rowData, annual, ytdBudget, ytdActual, variance, isIncome) {
      var tr = table.insertRow();
      var indent = 8 + (rowData.depth * 20);

      // Data attributes for toggle
      tr.setAttribute('data-node-id', rowData.nodeId);
      if (rowData.parentId !== null) {
        tr.setAttribute('data-parent-node', rowData.parentId);
      }
      tr.setAttribute('data-has-children', rowData.hasChildren ? 'true' : 'false');

      // Style based on parent/leaf
      if (rowData.hasChildren) {
        tr.className = rowData.depth === 0 ? 'parent-row' : 'parent-row-deep';
        tr.onclick = function() { toggleChildren(rowData.nodeId, tableId); };
      } else {
        tr.className = 'leaf-row';
      }

      // Hide child rows by default (depth > 0)
      if (rowData.parentId !== null) {
        tr.style.display = 'none';
      }

      var nameCell = tr.insertCell(0);
      var annualCell = tr.insertCell(1);
      var ytdBudgetCell = tr.insertCell(2);
      var ytdActualCell = tr.insertCell(3);
      var varianceCell = tr.insertCell(4);
      var pctCell = tr.insertCell(5);

      // Toggle arrow + name
      var nameHtml = '';
      if (rowData.hasChildren) {
        nameHtml = '<span class="toggle">\u25B6 </span>' + rowData.name;
      } else {
        nameHtml = '<span class="toggle"></span>' + rowData.name;
      }
      nameCell.innerHTML = nameHtml;
      nameCell.style.paddingLeft = indent + 'px';

      annualCell.textContent = fmt(annual);
      ytdBudgetCell.textContent = fmt(ytdBudget);
      ytdActualCell.textContent = fmt(ytdActual);
      varianceCell.textContent = fmt(variance);
      varianceCell.className = variance >= 0 ? 'favorable' : 'unfavorable';
      pctCell.textContent = pct(ytdActual, annual);
      pctCell.className = 'pct-cell';
    }

    function addTotalRow(table, label, annual, ytdBudget, ytdActual, variance, isIncome) {
      var tr = table.insertRow();
      tr.className = 'total-row';
      var nameCell = tr.insertCell(0);
      var annualCell = tr.insertCell(1);
      var ytdBudgetCell = tr.insertCell(2);
      var ytdActualCell = tr.insertCell(3);
      var varianceCell = tr.insertCell(4);
      var pctCell = tr.insertCell(5);

      nameCell.textContent = label;
      annualCell.textContent = fmt(annual);
      ytdBudgetCell.textContent = fmt(ytdBudget);
      ytdActualCell.textContent = fmt(ytdActual);
      varianceCell.textContent = fmt(variance);
      varianceCell.className = variance >= 0 ? 'favorable' : 'unfavorable';
      pctCell.textContent = pct(ytdActual, annual);
      pctCell.className = 'pct-cell';
    }

    loadData();
  </script>
</body>
</html>
